<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poop me please - Victorian Carnival</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --carnival-red: #5e0000;
            --carnival-gold: #c5a059;
            --wood-dark: #2a1b0d;
            --parchment: #d2b48c;
            --gun-wood: #4d2d18;
            --gun-metal: #2c2c2c;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #0a0a0a;
            font-family: 'Georgia', 'Times New Roman', serif;
            cursor: crosshair; 
            user-select: none;
            color: #2a1b0d;
        }

        .background-scene {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #0a0c1a 0%, #1a1a2e 100%);
            z-index: 0;
        }

        .coral-gate-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1;
            background-image: radial-gradient(circle at center, transparent 30%, #000 100%),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cpath fill='none' stroke='%23c5a059' stroke-width='2' d='M100 0c0 50-50 50-50 100s50 50 50 100M100 0c0 50 50 50 50 100s-50 50-50 100'/%3E%3Cpath fill='none' stroke='%23c5a059' stroke-width='1' d='M0 100c50 0 50-50 100-50s50 50 100 50M0 100c50 0 50 50 100 50s50-50 100-50'/%3E%3Ccircle cx='100' cy='100' r='20' fill='none' stroke='%23c5a059'/%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 35vh;
            background: #1a0f0a;
            perspective: 1000px;
            overflow: hidden;
            z-index: 2;
        }

        .red-carpet {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) rotateX(60deg);
            width: 40%;
            height: 200%;
            background: linear-gradient(to top, #7a0000, #4a0000);
            box-shadow: 0 0 50px rgba(122, 0, 0, 0.5);
            border-left: 10px solid #c5a059;
            border-right: 10px solid #c5a059;
        }

        .light-string {
            position: absolute;
            top: 50px;
            width: 110%;
            height: 100px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            left: -5%;
            z-index: 5;
            display: flex;
            justify-content: space-around;
            padding: 0 10%;
        }

        .bulb {
            width: 12px;
            height: 18px;
            background: #fff;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 0 15px #ffeb3b, 0 0 30px #ff9800;
            animation: flicker 2s infinite alternate;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.95); }
        }

        #barrier-rope {
            position: fixed;
            bottom: 110px;
            left: 0;
            width: 100%;
            height: 20px;
            z-index: 1600;
            background: repeating-linear-gradient(
                45deg,
                #cc0000,
                #cc0000 20px,
                #ffffff 20px,
                #ffffff 40px
            );
            border-top: 2px solid rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(0,0,0,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .rope-post {
            position: absolute;
            bottom: 0;
            width: 30px;
            height: 150px;
            background: linear-gradient(to right, #8b0000, #ff0000, #8b0000);
            border: 2px solid #5e0000;
            border-radius: 5px 5px 0 0;
            z-index: 1550;
        }

        #booth-counter {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: linear-gradient(to bottom, #3d2b1f, #2a1b0d);
            border-top: 8px solid #5a3e2b;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            z-index: 1500;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }

        .playbill {
            background: #d2b48c;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            width: 90%;
            max-width: 600px;
            padding: 40px;
            border: 15px solid #5e0000;
            border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect fill='%235e0000' width='100' height='100'/%3E%3Cpath fill='%23c5a059' d='M0 0l100 100M100 0L0 100' stroke-width='2'/%3E%3C/svg%3E") 25;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            text-align: center;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: none; 
            align-items: center;
            justify-content: center;
            perspective: 2000px;
            z-index: 10;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #booth-frame {
            position: relative;
            padding: 25px;
            background: #000;
            border: 12px solid #5e0000;
            box-shadow: 0 0 100px rgba(0,0,0,0.9), inset 0 0 40px #000;
            transform: scale(0.65) translateY(-50px);
            z-index: 100;
            overflow: visible; 
            border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect fill='%235e0000' width='40' height='40'/%3E%3Crect fill='%23c5a059' x='18' width='4' height='40'/%3E%3Crect fill='%23c5a059' y='18' width='40' height='4'/%3E%3C/svg%3E") 30 stretch;
        }

        .booth-header {
            position: absolute;
            top: -65px; left: 50%;
            transform: translateX(-50%);
            background: #5e0000;
            padding: 10px 50px;
            border: 5px double var(--carnival-gold);
            font-size: 3rem;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            z-index: 200;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #balloon-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(6, 1fr); 
            gap: 12px;
            padding: 20px;
            position: relative;
            z-index: 5;
        }

        .balloon {
            width: 32px;
            height: 42px;
            border-radius: 50% 50% 50% 50% / 45% 45% 55% 55%;
            position: relative;
            transition: all 0.2s;
            background: 
                radial-gradient(circle at 35% 30%, rgba(255,255,255,0.8) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--bg-color) 0%, rgba(0,0,0,0.4) 100%);
        }

        #gun-wrapper {
            position: fixed;
            bottom: -50px; 
            left: 50%;
            width: 300px;
            height: 380px; 
            transform: translateX(-50%);
            z-index: 2000; 
            pointer-events: none;
            transform-origin: bottom center;
        }

        #gun-visual {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .gun-barrel {
            width: 20px; 
            height: 160px; 
            background: linear-gradient(to right, #111, #2a2a2a, #111);
            border-radius: 4px 4px 0 0;
            position: relative;
            z-index: 2;
        }

        .gun-stock {
            width: 70px;
            height: 140px;
            background: linear-gradient(to right, #2b1810, #4d2d18, #2b1810);
            border-radius: 10px 10px 40px 40px;
            margin-top: -20px;
            position: relative;
            z-index: 1;
            border: 1px solid #000;
        }

        #inventory {
            position: fixed;
            bottom: 135px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border: 4px solid #5e0000;
            width: 180px;
            z-index: 2000;
            left: 15px;
        }

        .teddy-bear {
            position: fixed;
            bottom: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 180px;
            z-index: 2500;
            pointer-events: none;
            transition: bottom 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .teddy-bear.show {
            bottom: 150px;
        }

        .muzzle-flash {
            position: fixed;
            width: 120px; height: 120px;
            background: radial-gradient(circle, rgba(255,255,200,0.9) 0%, transparent 80%);
            pointer-events: none;
            z-index: 1001;
            animation: flash_anim 0.08s ease-out forwards;
        }

        .explosion-flash {
            position: fixed;
            width: 250px; height: 250px;
            background: radial-gradient(circle, #ff0000 0%, #ff6600 50%, transparent 80%);
            pointer-events: none;
            z-index: 1002;
            animation: flash_anim 0.4s ease-out forwards;
        }

        @keyframes flash_anim {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        #aim-dot {
            position: fixed;
            width: 8px; height: 8px;
            background: #ff0000;
            border: 1px solid white;
            border-radius: 50%;
            display: none;
            z-index: 1000;
            pointer-events: none;
        }

        #game-over {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #1a0f0a;
            border: 10px solid var(--carnival-red);
            padding: 40px;
            text-align: center;
            display: none;
            z-index: 3000;
            color: white;
            min-width: 320px;
            max-width: 450px;
        }

        .comfort-msg {
            background: #d2b48c;
            color: #2a1b0d;
            padding: 12px;
            font-style: italic;
            border-left: 4px solid var(--carnival-gold);
            margin: 15px 0;
            font-size: 0.9rem;
            position: relative;
            min-height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .comfort-msg::before {
            content: "Host's Sympathy:";
            position: absolute;
            top: -18px;
            left: 0;
            display: block;
            font-weight: bold;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #c5a059;
        }

        .streak-counter {
            color: #fbbf24;
            font-size: 0.75rem;
            font-weight: 900;
        }

        .property-badge {
            background-color: #5e0000;
            border: 3px double #c5a059;
            padding: 10px 24px;
            color: #c5a059;
            font-family: 'Georgia', serif;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            font-size: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            transform: translateY(10px);
            position: relative;
        }
        
        .property-badge::before, .property-badge::after {
            content: 'â˜…';
            margin: 0 10px;
            font-size: 0.6rem;
            vertical-align: middle;
        }

        .difficulty-btn {
            background: #d2b48c;
            color: #5e0000;
            border: 3px solid #5e0000;
            padding: 10px 20px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            min-width: 140px;
        }

        .difficulty-btn.active {
            background: #5e0000;
            color: #c5a059;
            border-color: #c5a059;
            transform: scale(1.1);
        }

        .difficulty-btn:hover:not(.active) {
            background: #e1ccae;
        }

        /* Generic Victorian Button Style */
        .victorian-btn {
            background: #d2b48c;
            color: #5e0000;
            border: 2px solid #5e0000;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.7rem;
            padding: 4px 10px;
        }
        .victorian-btn:hover {
            background: #5e0000;
            color: #d2b48c;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="background-scene">
        <div class="coral-gate-bg"></div>
        <div class="light-string">
            <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
            <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
        </div>
        <div class="ground">
            <div class="red-carpet"></div>
        </div>
    </div>

    <div id="barrier-rope"></div>
    <div class="rope-post" style="left: 10%;"></div>
    <div class="rope-post" style="right: 10%;"></div>

    <div id="booth-counter">
        <div class="property-badge">Property of Junnel's Carnival</div>
    </div>

    <div id="intro-screen">
        <div class="playbill">
            <h1 class="text-6xl font-black text-red-900 border-b-4 border-red-900 pb-2 mb-4">POOP ME PLEASE</h1>
            <p class="text-xl italic text-stone-800 mb-6 font-bold">"Avoid the rigged balloons or lose everything!"</p>
            
            <div class="mb-8">
                <p class="text-sm font-black text-red-900 uppercase mb-3 tracking-widest">Select Your Challenge</p>
                <div class="flex justify-center gap-4">
                    <button id="btn-easy" onclick="setDifficulty('easy')" class="difficulty-btn active">Easy (5%)</button>
                    <button id="btn-medium" onclick="setDifficulty('medium')" class="difficulty-btn">Medium (10%)</button>
                    <button id="btn-hard" onclick="setDifficulty('hard')" class="difficulty-btn">Hard (30%)</button>
                </div>
            </div>

            <p class="text-xs text-red-900 mb-8 font-black uppercase tracking-tighter">5-STREAK REWARD: TEDDY BEAR & COMFORTING AI HOST</p>
            <button onclick="startGame()" class="bg-red-900 text-yellow-500 px-14 py-5 text-3xl font-black border-4 border-yellow-600 hover:bg-red-800 transition transform hover:scale-105">
                START GAME
            </button>
        </div>
    </div>

    <div id="prize-bear" class="teddy-bear">
        <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
            <circle cx="30" cy="30" r="15" fill="#8d6e63" />
            <circle cx="70" cy="30" r="15" fill="#8d6e63" />
            <circle cx="50" cy="60" r="40" fill="#a1887f" />
            <circle cx="50" cy="110" r="50" fill="#a1887f" />
            <circle cx="35" cy="50" r="5" fill="black" />
            <circle cx="65" cy="50" r="5" fill="black" />
            <circle cx="50" cy="70" r="12" fill="#d7ccc8" />
            <circle cx="50" cy="65" r="4" fill="black" />
        </svg>
    </div>

    <div id="sniper-overlay" class="fixed inset-0 pointer-events-none z-[1000] hidden opacity-0 transition-opacity duration-300 bg-[radial-gradient(circle_at_center,transparent_15%,rgba(0,0,0,0.98)_40%)]">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[450px] h-[450px] border-[15px] border-[#5a4634] rounded-full shadow-[inset_0_0_60px_rgba(0,0,0,1),0_0_0_2000px_rgba(0,0,0,0.95)]"></div>
    </div>

    <div id="aim-dot"></div>

    <div id="game-container">
        <div class="fixed top-4 left-4 z-[1000] bg-white p-4 rounded-lg border-4 border-red-900 shadow-xl flex flex-col items-center">
            <h1 class="text-xl font-black text-red-900">SCORE: <span id="score" class="text-red-600">0</span></h1>
            <div class="streak-counter">STREAK: <span id="streak">0</span>/5</div>
            <p id="scope-hint" class="text-[10px] text-red-900 font-black italic mt-2 opacity-0">Right Click to Zoom</p>
            <p id="diff-label" class="text-[10px] text-stone-500 font-bold uppercase mt-1">Level: Easy</p>
            <button onclick="backToMenu()" class="mt-4 victorian-btn">MAIN MENU</button>
        </div>

        <div id="booth-frame">
            <div class="booth-header">POOP ME PLEASE</div>
            <div id="balloon-grid"></div>
        </div>

        <div id="inventory">
            <h3 class="font-black border-b-2 border-stone-800 mb-2">GALLERY RIFLES</h3>
            <div id="gun-list" class="text-sm">
                <div class="p-1 cursor-pointer hover:bg-red-800/10 font-bold" onclick="setGun('classic')">Standard Issue</div>
                <div class="p-1 cursor-pointer hover:bg-red-800/10 font-bold" onclick="setGun('marksman')">The Marksman (Zoom)</div>
            </div>
        </div>

        <div id="game-over">
            <h2 id="end-title" class="text-4xl text-red-500 mb-2 font-black uppercase text-center">BOOM!</h2>
            <p id="end-subtitle" class="text-stone-400 mb-3 italic text-center">You hit a rigged balloon.</p>
            <div id="comfort-container" class="comfort-msg"></div>
            <div class="text-2xl font-bold mb-6 text-center">FINAL SCORE: <span id="final-score" class="text-yellow-500">0</span></div>
            <div class="flex justify-center gap-4">
                <button onclick="resetGame()" class="px-8 py-3 border-4 border-yellow-600 text-yellow-600 hover:bg-yellow-900/20 font-black">RETRY</button>
                <button onclick="backToMenu()" class="px-8 py-3 border-4 border-stone-600 text-stone-600 hover:bg-stone-900/20 font-black">MENU</button>
            </div>
        </div>

        <div id="gun-wrapper">
            <div id="gun-visual">
                <div class="gun-barrel" id="barrel"></div>
                <div class="gun-stock"></div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const grid = document.getElementById('balloon-grid');
        const container = document.getElementById('game-container');
        const gunWrapper = document.getElementById('gun-wrapper');
        const barrel = document.getElementById('barrel');
        const scoreEl = document.getElementById('score');
        const streakEl = document.getElementById('streak');
        const bearEl = document.getElementById('prize-bear');
        const scopeOverlay = document.getElementById('sniper-overlay');
        const scopeHint = document.getElementById('scope-hint');
        const introScreen = document.getElementById('intro-screen');
        const comfortContainer = document.getElementById('comfort-container');
        const diffLabel = document.getElementById('diff-label');
        
        let score = 0;
        let streak = 0;
        let isGameOver = false;
        let isScoped = false;
        let currentGun = 'classic';
        let currentDifficulty = 'easy';
        
        const difficulties = {
            easy: { trapChance: 0.05, label: "Easy" },
            medium: { trapChance: 0.10, label: "Medium" },
            hard: { trapChance: 0.30, label: "Hard" }
        };

        const colors = ['#2ecc71', '#f1c40f', '#e91e63', '#0078ff', '#6a1b9a'];
        const guns = {
            classic: { barrelH: '160px', recoil: 10, zoom: false },
            marksman: { barrelH: '190px', recoil: 8, zoom: true }
        };

        const comfortFallbacks = [
            "Don't fret, traveler! The carnival is cruel, but your spirit is bright.",
            "A minor explosion for a major talent. Try once more, old bean!",
            "The balloons were rigged, but your aim was true! Step right back up, sport.",
            "A bit of soot on the face builds character, my dear friend!",
            "So close! Alas, the Teddy Bear misses you already.",
            "Chin up, traveler! Even the finest marksmen hit a snag occasionally."
        ];

        function setDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`btn-${level}`);
            if (btn) btn.classList.add('active');
            diffLabel.innerText = `Level: ${difficulties[level].label}`;
        }

        async function handleHostComfort(finalScore) {
            const randomFallback = comfortFallbacks[Math.floor(Math.random() * comfortFallbacks.length)];
            comfortContainer.innerText = randomFallback;

            let instructionText = `You are a Victorian Carnival Host. A player just lost with a score of ${finalScore}. Write one short, sympathetic sentence in your quirky Victorian style. `;
            
            if (currentDifficulty === 'hard') {
                instructionText += `The player was brave enough to attempt HARD level. You MUST mention the score of ${finalScore} and praise them specifically for taking on the HARD mode challenge with such a score. Use words like 'old bean' or 'traveler'.`;
            } else {
                instructionText += `The player was on ${currentDifficulty} mode. Just give a general Victorian sympathy message. No quotes.`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: instructionText }] }]
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (aiText) {
                        comfortContainer.innerText = aiText.trim();
                    }
                }
            } catch (err) { }
        }

        function startGame() {
            introScreen.style.display = 'none';
            container.style.display = 'flex';
            initGame();
        }

        function resetGame() {
            document.getElementById('game-over').style.display = 'none';
            bearEl.classList.remove('show');
            initGame();
        }

        function backToMenu() {
            // Close scope if active
            if (isScoped) toggleScope();
            
            document.getElementById('game-over').style.display = 'none';
            container.style.display = 'none';
            introScreen.style.display = 'flex';
            
            // Clean up state
            isGameOver = true; 
            grid.innerHTML = '';
        }

        function setGun(type) {
            if (isScoped) toggleScope();
            currentGun = type;
            barrel.style.height = guns[type].barrelH;
            scopeHint.style.opacity = guns[type].zoom ? "1" : "0";
        }

        function toggleScope() {
            if (!guns[currentGun].zoom || isGameOver) return;
            isScoped = !isScoped;
            if (isScoped) {
                scopeOverlay.classList.remove('hidden');
                setTimeout(() => scopeOverlay.classList.add('opacity-100'), 10);
                container.style.transform = 'scale(2.5)';
                document.getElementById('aim-dot').style.display = 'block';
            } else {
                scopeOverlay.classList.remove('opacity-100');
                container.style.transform = 'scale(1)';
                document.getElementById('aim-dot').style.display = 'none';
                setTimeout(() => { if(!isScoped) scopeOverlay.classList.add('hidden'); }, 200);
            }
        }

        function initGame() {
            grid.innerHTML = '';
            score = 0;
            streak = 0;
            isGameOver = false;
            scoreEl.innerText = score;
            streakEl.innerText = streak;

            const chance = difficulties[currentDifficulty].trapChance;

            for (let i = 0; i < 60; i++) {
                const b = document.createElement('div');
                b.className = 'balloon';
                const isBoom = Math.random() < chance;
                b.dataset.boom = isBoom;
                const color = colors[Math.floor(Math.random() * colors.length)];
                b.style.setProperty('--bg-color', color);
                grid.appendChild(b);
            }
        }

        document.addEventListener('mousemove', (e) => {
            if (isGameOver || introScreen.style.display !== 'none') return;
            const rect = gunWrapper.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = window.innerHeight; 
            const angle = Math.atan2(e.clientX - centerX, centerY - e.clientY);
            const rotation = Math.max(-45, Math.min(45, angle * (180/Math.PI)));
            gunWrapper.style.transform = `translateX(-50%) rotate(${rotation}deg)`;

            if (isScoped) {
                const panX = (window.innerWidth / 2 - e.clientX) * 1.5;
                const panY = (window.innerHeight / 2 - e.clientY) * 1.5;
                container.style.transform = `scale(2.5) translate(${panX / 2.5}px, ${panY / 2.5}px)`;
                const aimDot = document.getElementById('aim-dot');
                aimDot.style.left = (window.innerWidth / 2 - 4) + 'px';
                aimDot.style.top = (window.innerHeight / 2 - 4) + 'px';
            }
        });

        document.addEventListener('mousedown', (e) => {
            if (isGameOver || introScreen.style.display !== 'none') return;
            if (e.button === 2) { toggleScope(); return; }

            const recoilAmt = guns[currentGun].recoil;
            const currentRotation = gunWrapper.style.transform;
            gunWrapper.style.transform = currentRotation + ` translateY(${recoilAmt}px)`;
            setTimeout(() => { gunWrapper.style.transform = currentRotation; }, 50);

            let targetX = isScoped ? window.innerWidth / 2 : e.clientX;
            let targetY = isScoped ? window.innerHeight / 2 : e.clientY;

            const flash = document.createElement('div');
            flash.className = 'muzzle-flash';
            flash.style.left = targetX + 'px';
            flash.style.top = targetY + 'px';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 50);

            const target = document.elementFromPoint(targetX, targetY);

            if (target && target.classList.contains('balloon') && !target.dataset.popped) {
                target.dataset.popped = "true";
                if (target.dataset.boom === "true") {
                    streak = 0; 
                    streakEl.innerText = streak;
                    const boom = document.createElement('div');
                    boom.className = 'explosion-flash';
                    boom.style.left = targetX + 'px';
                    boom.style.top = targetY + 'px';
                    document.body.appendChild(boom);
                    setTimeout(() => boom.remove(), 400);
                    target.style.background = "red";
                    target.style.transform = "scale(2)";
                    target.style.opacity = "0";
                    endGame(false);
                } else {
                    target.style.opacity = "0";
                    target.style.transform = "scale(0)";
                    score++;
                    streak++;
                    scoreEl.innerText = score;
                    streakEl.innerText = streak;

                    if (streak >= 5) {
                        showPrize();
                        streak = 0; 
                        setTimeout(() => { streakEl.innerText = streak; }, 1000);
                    }
                    
                    if (score >= 60) endGame(true);
                }
            } else {
                // Clicking UI or background resets streak
                if (target && target.id !== 'game-container') {
                     streak = 0;
                     streakEl.innerText = streak;
                }
            }
        });

        function showPrize() {
            bearEl.classList.add('show');
            setTimeout(() => {
                bearEl.classList.remove('show');
            }, 3000);
        }

        function endGame(win) {
            isGameOver = true;
            if (isScoped) toggleScope();
            const title = document.getElementById('end-title');
            const subtitle = document.getElementById('end-subtitle');
            
            if (win) {
                title.innerText = "PERFECT CLEAR!";
                subtitle.innerText = "You missed every single trap. Incredible aim!";
                title.style.color = "#fbbf24";
                comfortContainer.innerText = "A flawless performance, old bean! You are a master of the gallery.";
            } else {
                title.innerText = "BOOM!";
                subtitle.innerText = "You hit a rigged balloon.";
                title.style.color = "#ef4444";
                handleHostComfort(score);
            }
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over').style.display = 'block';
        }
    </script>
</body>
</html>

